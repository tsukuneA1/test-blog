---
import Layout from "../layouts/Layout.astro";
// 型定義を追加
type Category = {
  id: number;
  name: string;
  description: string;
  slug: string;
};

type Post = {
  id: number;
  title: {
    rendered: string;
  };
  date: string;
};

type Media = {
  id: number;
  source_url: string;
};


const response = await fetch('http://test.local/wp-json/wp/v2/categories');
const categories: Category[] = await response.json();

export async function getStaticPaths() {
  const response = await fetch('http://test.local/wp-json/wp/v2/categories');
  const categories: Category[] = await response.json();

  return categories.map((category) => ({
    params: {
      category: category.slug,
    },
  }));
}

const currentCategory = categories.find(cat => cat.slug === Astro.params.category);

const categoryName = currentCategory ? currentCategory.name : '';
const categoryDescription = currentCategory ? currentCategory.description : '';
const categoryId = currentCategory ? currentCategory.id : null;

let posts: Post[] = [];
let postTitles: string[] = [];
let postIds: number[] = [];
let postDates: string[] = [];
let postImages: string[] = [];

if (categoryId) {
  const postsResponse = await fetch(`http://test.local/wp-json/wp/v2/posts?categories=${categoryId}`);
  posts = await postsResponse.json();

  postTitles = posts.map(post => post.title.rendered);
  postIds = posts.map(post => post.id);
  postDates = posts.map(post => post.date);
}
---

<Layout title="wincblog">
  <main>
    <h1>{categoryName}</h1>
    <p>{categoryDescription}</p>

    {postTitles.length > 0 ? (
      <ul>
        {postTitles.map((postTitle, index) => {
          const year = postDates[index].substring(0, 4);
          const month = postDates[index].substring(5, 7);
          const date = postDates[index].substring(8, 10);
          const postId = postIds[index];
          return (
            <li key={index}>
              <div class="blog">
                <div class="picture">
                  <img src={`http://test.local/wp-content/uploads/${year}/${month}/${postId}-1024x768.jpg`} alt={postTitle} class="post-image" />
                </div>
                <div class="post">
                  <a href={`./${postIds[index]}`}>{postTitle}</a>
                  <p class="date">投稿日: {year}年{month}月{date}日</p>
                </div>
              </div>
            </li>
          );
        })}
      </ul>
    ) : (
      <p>投稿がありません</p>
    )}
  </main>
</Layout>

<style>
  h1{
    color: #0E3E81;
    font-family: "Zen Kurenaido";
    font-size: 128px;
    font-style: normal;
    font-weight: 400;
    line-height: normal;
  }
  .post-image {
    max-width: 100%; 
    height: 200px; 
    width: 200px;
    object-fit: cover;
    display: block;
  }

  .blog {
    margin-bottom: 20px; 
    display: flex;
    justify-content: center;
    margin: 0 auto;
  }

  main {
    margin: auto;
    padding: 1em;
    max-width: 80%;
    text-align: center;
  }
  ul {
    padding: 0;
    list-style-type: none;
  }

  li {
    margin-bottom: 10px;
  }

  a {
    color: #232428;
    font-size: 32px;
    font-style: normal;
    font-weight: 300;
    line-height: normal;
    letter-spacing: 6.4px;
    text-decoration: none;
  }

  p{
    color: #232428;
    font-family: "Zen Kaku Gothic New";
    font-size: 16px;
    font-style: normal;
    font-weight: 300;
    line-height: normal;
    letter-spacing: 3.2px;
  }

  a:hover {
    background: rgb(179, 179, 239);
  }
  .post{
    width: 759px;
    height: 200px;
    flex-shrink: 0;
    border: 1px solid #000;
    background: #FFF;
  }
  .picture{
    width: 200px;
    height: 200px;
    flex-shrink: 0;
    border: 1px solid #000;
    background: #FFF;
  }
</style>
